on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for new submodule tag
        id: check_tag
        run: |
          cd lucide
          
          # Get current submodule commit
          current_commit=$(git rev-parse HEAD)
          echo "Current commit: $current_commit"
          
          # Fetch all tags
          git fetch --tags --all
          
          # Get the latest tag
          latest_tag=$(git describe --tags --abbrev=0 origin/main 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null)
          echo "Latest tag: $latest_tag"
          
          # Get commit of latest tag
          latest_tag_commit=$(git rev-list -n 1 "$latest_tag")
          echo "Latest tag commit: $latest_tag_commit"
          
          # Get the tag of current commit if it exists
          current_tag=$(git describe --tags --exact-match "$current_commit" 2>/dev/null || echo "")
          echo "Current tag: $current_tag"
          
          # Check if we need to update
          if [ "$current_commit" != "$latest_tag_commit" ]; then
            echo "New tag found: $latest_tag"
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "new_tag=$latest_tag" >> $GITHUB_OUTPUT
            echo "new_commit=$latest_tag_commit" >> $GITHUB_OUTPUT
          else
            echo "Already at latest tag: $latest_tag"
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Update submodule to new tag
        if: steps.check_tag.outputs.has_new_tag == 'true'
        run: |
          cd lucide
          # Checkout tag (submodules are meant to be in detached HEAD state)
          git checkout --quiet ${{ steps.check_tag.outputs.new_tag }}
          cd ..
          git add lucide
          git commit -m "chore: update lucide submodule to ${{ steps.check_tag.outputs.new_tag }}"

      - name: Create and push tag
        if: steps.check_tag.outputs.has_new_tag == 'true'
        run: |
          tag_name="${{ steps.check_tag.outputs.new_tag }}"
          git tag -a "$tag_name" -m "Update to lucide $tag_name"
          
          # Push commit and tags
          echo "Pushing changes to repository..."
          if git push origin main --tags; then
            echo "✅ Successfully pushed commit and tag: $tag_name"
          else
            echo "❌ Failed to push. Check repository permissions."
            echo "Go to Settings → Actions → General → Workflow permissions"
            echo "and enable 'Read and write permissions'"
            exit 1
          fi

      - name: No updates needed
        if: steps.check_tag.outputs.has_new_tag == 'false'
        run: echo "Submodule is already at the latest tag"
